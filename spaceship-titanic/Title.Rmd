---
title: "The Spaceship Titanic Incident"
author: "Darren Wong"
date: '2022-04-01'
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This is my first Kaggle submission, as well as one of my first forays into machine learning. In this report I'll be tackling the binary classification problem of determining whether a passenger on the Spaceship Titanic has been inadvertently and unfortunately teleported to an alternate dimension. This write-up will be structured in the following general way:

-   Exploratory data analysis (EDA)
-   Feature importance using mutual information and weight of information/information value
-   Imputation and prediction of missing values using the `mice` package
-   Model training and validation using random forests
-   Final prediction for the test set provided by Kaggle

Before we begin, some links and setup code:

-   This write-up is inspired by the excellent report written by Megan L. Risdal: [Exploring Survival on the Titanic](https://www.kaggle.com/code/mrisdal/exploring-survival-on-the-titanic/report)
-   [Kaggle competition link](https://www.kaggle.com/competitions/spaceship-titanic/overview)

```{r setup-libraries, warning = FALSE, message = FALSE}
library(tidyverse)    # Data manipulation and cleaning
library(data.table)   # Same as above & utilities for loading/saving csvs
library(ggplot2)      # Charting
library(scales)       # Prettier printing of values in charts
library(gridExtra)    # Arrange multiple ggplot2 plots on one chart
library(infotheo)     # Mutual information
library(Information)  # Weight of evidence/information value
library(mice)         # Missing value prediction
library(randomForest) # Random forests
library(caret)        # Confusion matrices

# Set working directory
setwd('~/Documents/Projects/kaggle/spaceship-titanic')
```

We can now load the data-sets that Kaggle provides us and then bind them together.

```{r setup-loads, warning = FALSE, message = FALSE}
train <- fread('raw-data/train.csv') %>% as_tibble()
test  <- fread('raw-data/test.csv') %>% as_tibble()

all   <- bind_rows(
  train %>% mutate(dataset = 'train'),
  test %>% mutate(dataset = 'test')
) 
```

# Exploratory Data Analysis

Some quick glimpses at the data to get a sense of what we're working with:

```{r eda-glimpse}
# We have 15 variables and 12,970 observations
glimpse(all)
```

```{r eda-cardinality}
# View cardinality of variables
all %>% 
  select(-dataset) %>% 
  sapply(n_distinct)
```

For completeness, I'll include the data explanations provided by Kaggle here:

| Variable                                          | Description                                                                                                                                               |
|-------------------------------------|-----------------------------------|
| PassengerId                                       | Unique ID for each passenger, in the format `gggg_pp` where `gggg` represents the travelling group and `pp` is the number of the individual in the group. |
| HomePlanet                                        | The planet the passenger departed from.                                                                                                                   |
| CryoSleep                                         | Whether the passenger chose to be put into cryosleep over the voyage. Passengers in cryosleep are confined to their cabins.                               |
| Cabin                                             | The cabin number where the passenger is staying. Takes the form `deck/num/side`, where `side` can be either `P` for Port or `S` for Starboard.            |
| Destination                                       | The planet the individual is travelling to.                                                                                                               |
| Age                                               | The age of the passenger.                                                                                                                                 |
| VIP                                               | Whether the passenger has paid for special VIP service during the voyage.                                                                                 |
| RoomService, FoodCourt, ShoppingMall, Spa, VRDeck | Amount the passenger has billed at each of the *Spaceship Titanic*'s many luxury amenities.                                                               |
| Name                                              | The first and last names of the passenger.                                                                                                                |
| Transported                                       | Whether the passenger was transported to another dimension, the target column.                                                                            |

Already we see some features that are candidates for one form of engineering or another:

-   `PassengerId` has travel group information in it
-   `Cabin` can be split into deck, room number, and side which may be useful variables

We'll now split the EDA work into categorical variables and numeric variables.

## Categorical variables & booleans

Let's first view the distinct value sets and their distributions for the cardinality categorical variables.

```{r eda-cat-low-cardinality, fig.height = 7, fig.width = 8, fig.align='center'}
all %>% 
  # Variables of interest
  select(HomePlanet, Destination, CryoSleep, VIP) %>% 
  gather(variable, value) %>% 
  # Calculating percentage distributions for each value
  group_by(variable, value) %>% 
  summarise(
    n = n(),
    .groups = 'drop'
  ) %>% 
  group_by(variable) %>% 
  mutate(percentage = n / sum(n)) %>% 
  ungroup() %>% 
  # Charting
  ggplot(aes(x = value, y = percentage, label = percent(percentage, accuracy = 0.1))) +
  geom_col() +
  facet_wrap(vars(variable), scales = 'free') +
  # Label formatting
  labs(x = 'Value', y = 'Percent', title = 'Fig 1. Dsn of Categorical Variables') +
  geom_text(
    position = position_dodge(width = .9),
    vjust = -0.5,
    size = 3
  ) + 
  scale_y_continuous(labels = percent)
```

Some takeaways from this chart:

-   Missing values seem to take the form of empty strings for Destination & HomePlanet;
-   We'll want to be careful with the VIP variable since they make up such a small percentage of total passengers;
-   62.3% of passengers opted to not be put into cryosleep; and,
-   The majority of passengers have Earth as their home planet, and the majority of passengers are travelling to TRAPPIST-1e.

To round this off, lets use some frequency tables to see how the rate of inadvertent transportation to an alternate dimension varies within each of these variables.

**HomePlanet vs. Transported**

```{r eda-cat-freq-table-1}
#  People from Europa seem to be transported at a higher frequency than people from other planets
#  People from Earth seem to be transported at a lower frequency
table(train$HomePlanet, train$Transported) %>% prop.table(1)
```

It appears that people from Europa are transported at a higher frequency, while people from Earth seem to be transported at a lower frequency.

**Destination vs. Transported**

```{r eda-cat-freq-table-2}
table(train$Destination, train$Transported) %>% prop.table(1)
```

People headed to 55 Cancri e seem to be transported at a higher frequency than the other destinations.

**CryoSleep vs. Transported**

```{r eda-cat-freq-table-3}
table(train$CryoSleep, train$Transported) %>% prop.table(1)
```

People in `CryoSleep` seem to be transported at a higher frequency than not.

**VIP vs. Transported**

```{r eda-cat-freq-table-4}
table(train$VIP, train$Transported) %>% prop.table(1)
```

People in VIP tend to be transported less, however be wary of this variable as there is only very small percentage of passengers are VIPs.

### Deeper dive into `Cabin`

Let's have a closer look at the `Cabin` variable, and the three substituent pieces of information it provides. First we'll split the `Cabin` variable into `Deck`, `Num` (room number), and `Side`, then we'll view the distributions of the categorical information provided by `Deck` and `Side`.

```{r eda-cat-cabin-cut, fig.height = 5, fig.width = 8, fig.align = 'center'}
all_cabin_spl <- all %>% 
  mutate(Cabin = na_if(Cabin, "")) %>% 
  separate(Cabin, c("Deck", "Num", "Side"), "/")

all_cabin_spl %>% 
  # Variables of interest
  select(Deck, Side) %>% 
  gather(variable, value) %>% 
  # Calculating percentage distributions for each value
  group_by(variable, value) %>% 
  summarise(
    n = n(),
    .groups = 'drop'
  ) %>% 
  group_by(variable) %>% 
  mutate(percentage = n / sum(n)) %>% 
  ungroup() %>% 
  # Charting
  ggplot(aes(x = value, y = percentage, label = percent(percentage, accuracy = 0.1))) +
  geom_col() +
  facet_wrap(vars(variable), scales = 'free') +
  # Label formatting
  labs(x = 'Value', y = 'Percent', title = 'Fig 2. Dsn of Deck and Side') +
  geom_text(
    position = position_dodge(width = .9),
    vjust = -0.5,
    size = 3
  ) + 
  scale_y_continuous(labels = percent)
```

At a glance, passengers tend to be more heavily weighted towards decks F and G, with a very small allocation to deck T. The distribution between port and starboard sides seems to be around equal.

Let's quickly check how the rate of transportation to an alternative dimension varies with these features:

**Deck vs. Transported**

```{r eda-cat-freq-table-5}
# Pull only examples from the training dataset as these have non-NA Transported values
train_cabin_spl <- all_cabin_spl %>% filter(dataset == 'train') %>% select(-dataset)

table(train_cabin_spl$Deck, train_cabin_spl$Transported) %>% prop.table(1)
```

Passengers on decks B, C, E, T all seem to be transported at a varying rate.

**Side vs. Transported**

```{r eda-cat-freq-table-6}
table(train_cabin_spl$Side, train_cabin_spl$Transported) %>% prop.table(1)
```

Doesn't look like transportation rate varies much with what side the passenger was on.

### Deeper dive into `PassengerId`

Let's see if the traveller's group size will be helpful for our purposes, first we'll see what the distribution of group sizes looks like.

```{r eda-cat-passengerid}
# Separate the PassengerId variable into a Group and Passenger ID.
all_grp_sep <- all %>% 
  separate(PassengerId, c('GroupId', 'PassengerId'), "_")

# Get number of individuals within each group ID.
all_grps <- all_grp_sep %>% 
  distinct(GroupId, PassengerId) %>% 
  group_by(GroupId) %>% 
  summarise(
    group_size = n(), 
    .groups = 'drop'
  )

# View distribution of group sizes
all_grps %>% 
  ggplot(aes(x = group_size)) +
  geom_histogram() +
  scale_x_continuous(breaks = unique(all_grps$group_size) %>% sort()) +
  scale_y_continuous(labels = comma) +
  labs(x = 'Group Size', y = "Count", title = "Distribution of Travel Group Sizes")
```

To round this out, we'll have a quick look at how alternate dimension transportation varies across group sizes.

```{r eda-cat-group-size}
# Add the new group size variable onto the main dataset then filter only for the training set
all_grouped <- all_grp_sep %>% left_join(all_grps, by = 'GroupId')

train_grouped <- all_grouped %>% filter(dataset == 'train') %>% select(-dataset)

table(train_grouped$group_size, train_grouped$Transported) %>% prop.table(1)
```

It looks like transportation rate varies a little bit with group size.

That's it for the categorical variables, we'll move on to the numerical variables now. *Note to self*: We may be able to infer with questionable success the gender of each individual which may be a useful feature.

## Numerical variables

The following are the numeric variables available to us as well as their quartiles and number of NAs present.

```{r eda-num-overview}
# All stock features
all %>% 
  select(-dataset) %>% 
  select_if(is.numeric) %>% 
  summary()

# + the room number of the passenger
all_cabin_spl %>% 
  select(Num) %>% 
  mutate(Num = as.numeric(Num)) %>% 
  summary()
```
